// ============================================================
//  src/world.js
//
//  Instead of returning 700+ individual Cube objects,
//  buildWorld() now fills two CubeBatch instances:
//    g_batchStone  — texture 0 (stone,  heights 1-3)
//    g_batchBrick  — texture 1 (brick,  height 4)
//
//  The entire world is drawn with exactly 2 draw calls.
//  Call rebuildBatches(gl) whenever the map changes.
// ============================================================

'use strict';

// prettier-ignore
var g_map = [
  [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,4],
  [4,0,0,0,2,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,3,0,0,0,4],
  [4,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,3,0,0,0,4],
  [4,0,0,0,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,4,0,4,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,4,0,4,0,0,0,0,0,0,0,0,0,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,3,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,3,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,3,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,2,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,2,0,2,0,2,0,0,0,0,0,0,0,0,0,0,4,4,4,4,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,4,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,4,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,0,4,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4],
  [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
];

// Two batches — declared in main.js, assigned here
// Call once at startup (and again after addBlock/removeBlock)
function buildWorld(gl) {
  var ROWS = g_map.length;
  var COLS = g_map[0].length;
  var stone = [], brick = [];

  for (var row = 0; row < ROWS; row++) {
    for (var col = 0; col < COLS; col++) {
      var h = g_map[row][col];
      if (h === 0) continue;
      var isBrick = (h >= 4);

      for (var y = 0; y < h; y++) {
        var desc = {
          tx: col + 0.5,
          ty: y   + 0.5,
          tz: row + 0.5,
          sx: 1, sy: 1, sz: 1
        };
        if (isBrick) brick.push(desc);
        else         stone.push(desc);
      }
    }
  }

  if (!g_batchStone) g_batchStone = new CubeBatch();
  if (!g_batchBrick) g_batchBrick = new CubeBatch();
  g_batchStone.build(gl, stone, 0);
  g_batchBrick.build(gl, brick, 1);
}

// Alias so the old buildWorld() call pattern still works
// (main.js calls buildWorld() but now needs gl — we patch main.js below)
function rebuildBatches(gl) { buildWorld(gl); }

// ── Map editing ───────────────────────────────────────────────
function addBlock(col, row) {
  if (col < 0 || col >= 32 || row < 0 || row >= 32) return false;
  if (g_map[row][col] >= 4) return false;
  g_map[row][col]++;
  return true;
}

function removeBlock(col, row) {
  if (col < 0 || col >= 32 || row < 0 || row >= 32) return false;
  if (g_map[row][col] <= 0) return false;
  g_map[row][col]--;
  return true;
}

function getBlockHeight(col, row) {
  if (col < 0 || col >= 32 || row < 0 || row >= 32) return 0;
  return g_map[row][col];
}